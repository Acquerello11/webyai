<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alice Moist Daily - สมัครสมาชิก/ล็อกอิน</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #183a7a;
      --primary-dark: #10244d;
      --accent: #e0eafc;
      --bg: #f0f8ff;
      --bg2: #f8fafc;
      --danger: #e74c3c;
      --success: #2ecc71;
      --text-main: #183a7a;
      --text-muted: #7b8fa6;
      --shadow: 0 4px 18px 0 rgba(24,58,122,0.10), 0 2px 8px rgba(44,62,80,0.06);
      --shadow-hover: 0 8px 32px 0 rgba(24,58,122,0.13), 0 4px 16px rgba(44,62,80,0.09);
      --glass: #fff;
      --glass-hover: #fafdff;
      --border: 1.5px solid #e0e0e0;
      --border-hover: 1.5px solid #183a7a44;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Kanit', sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(120deg, var(--bg) 0%, var(--accent) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      position: relative;
      overflow-x: hidden;
    }

    .login-container {
      display: flex;
      flex-direction: row;
      background: rgba(255,255,255,0.7);
      border-radius: 32px;
      box-shadow: 0 8px 32px 0 rgba(52,152,219,0.13), 0 4px 16px rgba(44,62,80,0.09);
      max-width: 820px;
      width: auto;
      min-height: unset;
      margin: 32px 0;
      position: relative;
      z-index: 2;
      overflow: visible;
      align-items: stretch;
    }

    .login-hero {
      flex: 0 1 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(120deg, #e0eafc 0%, #f0f8ff 100%);
      border-radius: 32px 0 0 32px;
      padding: 32px 24px 32px 32px;
      min-width: 240px;
      max-width: 340px;
      box-shadow: 0 2px 12px #3498db11;
      position: relative;
    }

    .hero-logo {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      box-shadow: 0 2px 12px #3498db33;
      border: 3px solid #e3f2fd;
      background: #fff;
      object-fit: cover;
      margin-bottom: 18px;
    }

    .hero-title {
      font-size: 2.2rem;
      font-weight: 800;
      color: #183a7a;
      margin: 0 0 10px 0;
      background: linear-gradient(90deg,#183a7a 60%,#10244d 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }

    .hero-desc {
      color: #4a6fa1;
      font-size: 1.13rem;
      font-weight: 500;
      text-align: center;
      margin: 0 0 8px 0;
      line-height: 1.7;
    }

    .hero-desc-sub {
      color: #183a7a;
      font-size: 1.01rem;
      font-weight: 600;
      display: block;
      margin-top: 6px;
    }

    .hero-illustration {
      width: 100%;
      max-width: 320px;
      border-radius: 18px;
      box-shadow: 0 4px 24px #3498db22;
      margin-top: 18px;
      object-fit: cover;
    }

    .login-card {
      flex: 0 1 380px;
      background: #fff;
      border-radius: 0 32px 32px 0;
      box-shadow: none;
      max-width: 420px;
      width: auto;
      padding: 32px 24px 28px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      border: none;
      min-width: 260px;
      overflow: visible;
    }

    .nav-quick-btns {
      display: flex;
      justify-content: center;
      gap: 28px;
      margin-bottom: 32px;
      margin-top: 0;
      width: 100%;
    }

    .quick-nav-btn {
      background: #fff;
      border: 1.5px solid #b0beca;
      color: var(--primary);
      font-size: 1.05rem;
      font-weight: 500;
      border-radius: 8px;
      padding: 10px 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: none;
      transition: background 0.15s, color 0.15s, border 0.15s;
      outline: none;
      font-family: 'Kanit', sans-serif;
      margin-bottom: 6px;
      letter-spacing: 0.2px;
    }

    .quick-nav-btn i {
      font-size: 1.2em;
      margin-right: 7px;
    }

    .quick-nav-btn.main-btn {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      font-weight: 600;
      box-shadow: 0 2px 8px var(--primary)10;
    }

    .quick-nav-btn.main-btn:hover, .quick-nav-btn.main-btn:focus {
      background: var(--primary-dark);
      color: #fff;
      border-color: var(--primary-dark);
    }

    .quick-nav-btn.shopping-btn {
      background: #fff;
      color: var(--primary);
      border: 1.5px solid var(--primary);
      font-weight: 600;
    }

    .quick-nav-btn.shopping-btn:hover, .quick-nav-btn.shopping-btn:focus {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .quick-nav-btn:hover, .quick-nav-btn:focus {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .login-tabs {
      display: flex;
      width: 100%;
      margin-bottom: 22px;
      border-bottom: 1.5px solid #e3eafc;
      background: transparent;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
    }

    .login-tab {
      flex: 1;
      padding: 12px 0 10px 0;
      background: none;
      border: none;
      font-size: 1.08rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
      outline: none;
      position: relative;
      border-radius: 10px 10px 0 0;
      letter-spacing: 0.4px;
    }

    .login-tab.active {
      color: var(--primary);
      background: #e3f2fd;
      box-shadow: 0 1px 4px var(--primary)08;
    }

    .login-tab.active::after {
      content: "";
      position: absolute;
      left: 18%;
      bottom: -2.5px;
      width: 64%;
      height: 2px;
      background: var(--primary);
      border-radius: 2px;
      box-shadow: 0 1px 4px var(--primary)11;
    }

    .login-forms {
      width: 100%;
    }

    .login-form {
      display: none;
      flex-direction: column;
      gap: 0;
    }

    .login-form.active {
      display: flex;
    }

    .form-title {
      font-size: 1.15rem;
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 14px;
      text-align: left;
    }

    .login-title-inline {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.6rem;
      color: #183a7a;
      margin-bottom: 28px;
      justify-content: flex-start;
    }

    .login-title-icon {
      font-size: 2.1rem;
      color: #183a7a;
    }

    .login-btn-icon {
      margin-right: 8px;
    }

    .form-group {
      margin-bottom: 22px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .form-group input:focus + label,
    .form-group input:not(:placeholder-shown) + label {
      transform: translateY(-22px) scale(0.92);
      color: var(--primary);
      background: #fff;
      padding: 0 6px;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 2px 8px var(--primary)08;
    }

    .form-group label {
      position: absolute;
      left: 18px;
      top: 16px;
      pointer-events: none;
      font-weight: 500;
      color: var(--text-main);
      font-size: 1.05rem;
      background: transparent;
      transition: all 0.18s cubic-bezier(.4,2,.6,1);
      z-index: 2;
    }

    .form-control {
      width: 100%;
      padding: 18px 18px 12px 18px;
      border: 2px solid #e3eafc;
      border-radius: 16px;
      font-size: 1.13rem;
      background: rgba(255,255,255,0.99);
      transition: border 0.22s, box-shadow 0.22s, background 0.22s;
      color: var(--text-main);
      box-shadow: 0 2px 16px var(--primary)18;
      font-weight: 500;
      margin-bottom: 0;
      outline: none;
    }

    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 5px var(--primary)22;
      background: #fafdff;
    }

    .input-icon {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #95a5a6;
      z-index: 2;
    }

    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(90deg,var(--primary) 60%,var(--primary-dark) 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 1.18rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.18s;
      margin-top: 14px;
  box-shadow: 0 2px 16px var(--primary)22;
      letter-spacing: 0.35px;
      text-shadow: 0 1px 2px var(--primary-dark)22;
    }

    .btn:hover, .btn:focus {
      background: linear-gradient(90deg,var(--primary-dark) 60%,var(--primary) 100%);
      color: #fff;
      box-shadow: 0 6px 24px var(--primary)33;
      outline: none;
      transform: translateY(-2px) scale(1.04);
    }

    .form-footer {
      text-align: center;
      margin-top: 18px;
      color: var(--text-muted);
      font-size: 1.07rem;
      font-weight: 600;
      letter-spacing: 0.1px;
    }

    .forgot-label {
      color: #7b8fa6;
    }

    .forgot-link {
      color: #183a7a;
      font-weight: 600;
      text-decoration: none;
    }

    .forgot-link:hover {
      text-decoration: underline;
    }

    .form-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .form-footer a:hover {
      text-decoration: underline;
    }

    .error-message {
      color: var(--danger);
      font-size: 1.01rem;
      margin-top: 4px;
      display: none;
      font-weight: 600;
      letter-spacing: 0.12px;
      text-shadow: 0 1px 2px var(--danger)22;
    }

    .input-error {
      border-color: var(--danger) !important;
    }

    .verification-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .verification-modal.show {
      display: flex;
    }

    .verification-container {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      box-shadow: 0 4px 18px rgba(52,152,219,0.10);
      position: relative;
    }

    .verification-icon {
      font-size: 4rem;
      color: var(--primary);
      margin-bottom: 20px;
    }

    .verification-title {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--text-main);
    }

    .verification-text {
      color: #7f8c8d;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .verification-code {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .code-input {
      width: 50px;
      height: 60px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .code-input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .resend-link {
      color: var(--primary);
      cursor: pointer;
      margin-top: 20px;
      display: inline-block;
    }

    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 9999;
      background: #fff;
      color: #333;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      padding: 18px 28px;
      min-width: 220px;
      font-size: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(-20px);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification.success {
      border-left: 6px solid var(--success);
    }

    .notification.error {
      border-left: 6px solid var(--danger);
    }

    .notification.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .notification.hide {
      opacity: 0;
      pointer-events: none;
      transform: translateY(-20px);
    }

    .notification-content i {
      font-size: 1.3em;
      margin-right: 8px;
    }

    #registerForm, #loginForm {
      border: 1.5px solid #e0e0e0;
      border-radius: 18px;
      box-shadow: 0 4px 18px var(--primary)11, 0 1.5px 6px var(--primary-dark)08;
      background: #fff;
      padding: 35px 30px 30px 30px;
      margin-top: 10px;
    }

    /* Subtle background shapes */
    .login-bg::before {
      content: '';
      position: absolute;
      left: -120px;
      top: -120px;
      width: 340px;
      height: 340px;
      background: radial-gradient(circle, #e0eafc 60%, #f0f8ff 100%);
      border-radius: 50%;
      opacity: 0.5;
      z-index: 0;
    }

    .login-bg::after {
      content: '';
      position: absolute;
      right: -100px;
      bottom: -100px;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, #e0eafc 60%, #f0f8ff 100%);
      border-radius: 50%;
      opacity: 0.4;
      z-index: 0;
    }

    @media (max-width: 1100px) {
      .login-container {
        flex-direction: column;
        max-width: 420px;
        min-width: unset;
      }

      .login-hero {
        border-radius: 32px 32px 0 0;
        max-width: unset;
        min-width: unset;
        width: 100%;
        padding: 24px 12px 12px 12px;
      }

      .login-card {
        border-radius: 0 0 32px 32px;
        min-width: unset;
        max-width: unset;
        width: 100%;
        padding: 24px 12px 16px 12px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
      }

      .login-container {
  margin: 0;
        border-radius: 0;
        box-shadow: none;
      }

      .login-hero, .login-card {
        border-radius: 0;
        padding: 18px 4vw 8px 4vw !important;
      }

      .hero-logo {
        width: 60px;
        height: 60px;
      }

      .hero-title {
        font-size: 1.3rem;
      }

      .hero-desc {
        font-size: 0.98rem;
      }

      .form-title.login-title-inline {
        font-size: 1.15rem;
      }

      .nav-quick-btns {
        flex-direction: column;
        gap: 12px;
      }

      .quick-nav-btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="login-bg">
    <div class="login-container">
      <div class="login-hero">
        <img src="logo.png" alt="Alice Moist Daily" class="hero-logo" />
        <h1 class="hero-title">Alice Moist Daily</h1>
        <p class="hero-desc">สัมผัสประสบการณ์ช้อปปิ้งคอนแทคเลนส์<br>ที่ปลอดภัยและทันสมัย<br><span class="hero-desc-sub">สมัครสมาชิกหรือเข้าสู่ระบบเพื่อเริ่มต้นใช้งาน</span></p>
        <img src="../images/banner1.png" alt="Banner" class="hero-illustration" />
      </div>
      <div class="login-card">
        <div class="nav-quick-btns">
          <button class="quick-nav-btn main-btn" onclick="window.location.href='../index.html'">
            <i class="fas fa-home"></i> <span>หน้าหลัก</span>
          </button>
          <button class="quick-nav-btn shopping-btn" onclick="window.location.href='buyer-dashboard.html'">
            <i class="fas fa-shopping-cart"></i> <span>ช้อปปิ้ง</span>
          </button>
        </div>
        <div style="height: 8px;"></div>
        <div class="login-tabs">
          <button class="login-tab active" data-tab="login">เข้าสู่ระบบ</button>
          <button class="login-tab" data-tab="register">สมัครสมาชิก</button>
        </div>
        <div class="login-forms">
          <!-- Login Form -->
          <form id="loginForm" class="login-form active">
            <h2 class="form-title login-title-inline">
              <i class="fas fa-sign-in-alt login-title-icon"></i>
              เข้าสู่ระบบ
            </h2>
            <div class="form-group">
              <input type="text" id="loginUsername" class="form-control" placeholder=" " autocomplete="username">
              <label for="loginUsername">อีเมลหรือเบอร์โทรศัพท์</label>
              <div class="error-message" id="loginUsernameError"></div>
            </div>
            <div class="form-group">
              <div class="input-icon">
                <input type="password" id="loginPassword" class="form-control" placeholder=" " autocomplete="current-password">
                <label for="loginPassword">รหัสผ่าน</label>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
              </div>
              <div class="error-message" id="loginPasswordError"></div>
            </div>
            <button type="button" class="btn" id="loginBtn">
              <i class="fas fa-arrow-right login-btn-icon"></i> เข้าสู่ระบบ
            </button>
            <div class="form-footer">
              <span class="forgot-label">ลืมรหัสผ่าน?</span> <a href="#" id="forgotPassword" class="forgot-link">รีเซ็ตรหัสผ่าน</a>
            </div>
          </form>
          
          <!-- Register Form -->
          <form id="registerForm" class="login-form">
            <h2 class="form-title login-title-inline">
              <i class="fas fa-user-plus login-title-icon"></i>
              สมัครสมาชิก
            </h2>
            <div class="form-group">
              <input type="text" id="fullName" class="form-control" placeholder=" ">
              <label for="fullName">ชื่อ-นามสกุล</label>
              <div class="error-message" id="fullNameError"></div>
            </div>
            <div class="form-group">
              <input type="tel" id="phone" class="form-control" placeholder=" ">
              <label for="phone">เบอร์โทรศัพท์</label>
              <div class="error-message" id="phoneError"></div>
            </div>
            <div class="form-group">
              <input type="email" id="email" class="form-control" placeholder=" ">
              <label for="email">อีเมล</label>
              <div class="error-message" id="emailError"></div>
            </div>
            <div class="form-group">
              <div class="input-icon">
                <input type="password" id="password" class="form-control" placeholder=" ">
                <label for="password">รหัสผ่าน (6 ตัวขึ้นไป)</label>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
              </div>
              <div class="error-message" id="passwordError"></div>
            </div>
            <div class="form-group">
              <div class="input-icon">
                <input type="password" id="confirmPassword" class="form-control" placeholder=" ">
                <label for="confirmPassword">ยืนยันรหัสผ่าน</label>
                <span class="password-toggle"><i class="fas fa-eye"></i></span>
              </div>
              <div class="error-message" id="confirmPasswordError"></div>
            </div>
            <button type="button" class="btn" id="registerBtn">สมัครสมาชิก</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Email Verification Modal -->
  <div class="verification-modal" id="verificationModal">
    <div class="verification-container" style="position:relative;">
      <button id="closeVerificationModal" style="position:absolute;top:18px;right:18px;background:transparent;border:none;font-size:1.6rem;color:#3498db;cursor:pointer;z-index:10;" aria-label="ปิด">&times;</button>
      <div class="verification-icon">
        <i class="fas fa-envelope-open-text"></i>
      </div>
      <h2 class="verification-title">ยืนยันอีเมลของคุณ</h2>
      <p class="verification-text">เราได้ส่งรหัสยืนยันไปยังอีเมล <span id="userEmail">user@example.com</span> กรุณากรอกรหัสยืนยัน 6 หลักที่ได้รับในอีเมลของคุณ</p>
      <div class="verification-code">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 1">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 2">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 3">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 4">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 5">
        <input type="text" class="code-input" maxlength="1" aria-label="รหัสยืนยันหลักที่ 6">
      </div>
      <button class="btn" id="verifyBtn">ยืนยัน</button>
      <div class="form-footer">
        ไม่ได้รับอีเมล? <span class="resend-link" id="resendLink">ส่งอีกครั้ง</span>
      </div>
      <div class="form-footer" style="margin-top:18px;">
        <button class="btn" id="changeEmailBtn" style="background:#fff;color:#183a7a;border:1.5px solid #183a7a;margin-bottom:10px;">เปลี่ยนอีเมล</button>
        <button class="btn" id="backToLoginBtn" style="background:#f8fafc;color:#183a7a;border:1.5px solid #183a7a;">กลับไปหน้าเข้าสู่ระบบ</button>
      </div>
      <div id="changeEmailForm" style="display:none;margin-top:18px;">
        <input type="email" id="newEmailInput" class="form-control" placeholder="กรอกอีเมลใหม่">
        <button class="btn" id="submitChangeEmailBtn" style="margin-top:10px;">ยืนยันอีเมลใหม่</button>
      </div>
    </div>
  </div>
  
  <!-- Reset Password Modal -->
  <div class="verification-modal" id="resetPasswordModal">
    <div class="verification-container">
      <div class="verification-icon">
        <i class="fas fa-key"></i>
      </div>
      <h2 class="verification-title">รีเซ็ตรหัสผ่าน</h2>
  <p class="verification-text">กรอกอีเมล รหัสผ่านใหม่ และยืนยันรหัสผ่าน</p>
      <div class="form-group">
        <input type="email" id="resetEmail" class="form-control" placeholder="อีเมล" required>
      </div>
      <div class="form-group">
        <input type="password" id="resetNewPassword" class="form-control" placeholder="รหัสผ่านใหม่ (6 ตัวขึ้นไป)" required>
      </div>
      <div class="form-group">
        <input type="password" id="resetConfirmPassword" class="form-control" placeholder="ยืนยันรหัสผ่านใหม่" required>
      </div>
      <button class="btn" id="resetPasswordBtn">รีเซ็ตรหัสผ่าน</button>
      <div class="form-footer">
        <a href="#" id="closeResetPasswordModal">ยกเลิก</a>
      </div>
    </div>
  </div>
  
  <script>
    // ==================== DOM Elements ====================
    const loginTab = document.querySelector('[data-tab="login"]');
    const registerTab = document.querySelector('[data-tab="register"]');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const verificationModal = document.getElementById('verificationModal');
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    const userEmailSpan = document.getElementById('userEmail');
    const resendLink = document.getElementById('resendLink');
    const verifyBtn = document.getElementById('verifyBtn');
    const codeInputs = document.querySelectorAll('.code-input');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const forgotPasswordLink = document.getElementById('forgotPassword');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const closeResetPasswordModal = document.getElementById('closeResetPasswordModal');
    const closeVerificationModal = document.getElementById('closeVerificationModal');
    
    // ==================== Constants ====================
    const API_BASE_URL = 'http://localhost:3000';
    
    // ==================== Utility Functions ====================
    function showError(fieldId, message) {
      const errorElement = document.getElementById(`${fieldId}Error`);
      const inputElement = document.getElementById(fieldId);
      
      if (errorElement && inputElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        inputElement.classList.add('input-error');
      }
    }
    
    function hideError(fieldId) {
      const errorElement = document.getElementById(`${fieldId}Error`);
      const inputElement = document.getElementById(fieldId);
      
      if (errorElement && inputElement) {
        errorElement.style.display = 'none';
        inputElement.classList.remove('input-error');
      }
    }
    
    function showNotification(message, type) {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
  notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
          ${message}
        </div>
      `;
      
      document.body.appendChild(notification);
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function showLoading(msg = 'กำลังดำเนินการ...') {
      let overlay = document.getElementById('loadingOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.style.position = 'fixed';
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(255,255,255,0.7)';
        overlay.style.zIndex = 2000;
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.innerHTML = `<div style="font-size:1.3rem;color:#3498db;background:#fff;padding:32px 48px;border-radius:18px;box-shadow:0 2px 16px #3498db22;">${msg}</div>`;
        document.body.appendChild(overlay);
      } else {
        overlay.style.display = 'flex';
      }
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
    }
    
    // ==================== Form Switching ====================
    function switchToLogin() {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.classList.add('active');
      registerForm.classList.remove('active');
    }

    function switchToRegister() {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerForm.classList.add('active');
      loginForm.classList.remove('active');
    }

    loginTab.addEventListener('click', switchToLogin);
    registerTab.addEventListener('click', switchToRegister);
    
    // ==================== Password Toggle ====================
    function setupPasswordToggles() {
      document.querySelectorAll('.password-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          const input = this.closest('.input-icon').querySelector('input');
          const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
          const icon = this.querySelector('i');
          
          input.setAttribute('type', type);
          icon.classList.toggle('fa-eye');
          icon.classList.toggle('fa-eye-slash');
        });
      });
    }
    
    // ==================== Email Verification ====================
    function showVerificationModal(email) {
      userEmailSpan.textContent = email;
      verificationModal.classList.add('show');
      document.getElementById('changeEmailForm').style.display = 'none';
      // Clear code inputs
      codeInputs.forEach(input => input.value = '');
      // Focus first input
      setTimeout(() => codeInputs[0].focus(), 100);
      // ตรวจสอบว่า modal โชว์จริงไหม
      setTimeout(() => {
        if (!verificationModal.classList.contains('show')) {
          showNotification('เกิดข้อผิดพลาด: ไม่สามารถแสดงหน้าต่างยืนยันอีเมล', 'error');
        }
      }, 300);
    }

    async function verifyEmail() {
      let code = '';
      codeInputs.forEach(input => { code += input.value; });

      if (code.length === 6 && /^\d{6}$/.test(code)) {
        const email = userEmailSpan.textContent;
        try {
          showLoading('กำลังยืนยันอีเมล...');

          // ส่งรหัสยืนยันไปยังเซิร์ฟเวอร์ (key ต้องเป็น code)
          const res = await fetch(`${API_BASE_URL}/api/user-login/verify-email`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: email,
              code: code
            })
          });

          const data = await res.json();

          if (res.ok && data.success) {
            showNotification('ยืนยันอีเมลสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว', 'success');
            // Save user data
            localStorage.setItem('buyer_email', email);
            // Close modal
            verificationModal.classList.remove('show');
            // ไม่ต้องสลับแท็บไปที่ล็อกอิน ให้ผู้ใช้กดสลับแท็บเอง
          } else {
            showNotification(data.error || 'รหัสยืนยันไม่ถูกต้อง', 'error');
          }
        } catch (e) {
          showNotification('เกิดข้อผิดพลาดในการยืนยันอีเมล', 'error');
        } finally {
          hideLoading();
        }
      } else {
        showNotification('กรุณากรอกรหัสยืนยัน 6 หลัก', 'error');
      }
    }
    
    // Auto-tab between code inputs
    codeInputs.forEach((input, index) => {
      input.addEventListener('input', () => {
        if (input.value.length === 1 && index < codeInputs.length - 1) {
          codeInputs[index + 1].focus();
        }
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value === '' && index > 0) {
          codeInputs[index - 1].focus();
        }
      });
    });
    
    // ==================== Login Functionality ====================
    async function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      // Clear errors
      hideError('loginUsername');
      hideError('loginPassword');

      let valid = true;

      // Validation
      if (!username) {
        showError('loginUsername', 'กรุณากรอกอีเมลหรือเบอร์โทรศัพท์');
        valid = false;
      }

      if (!password) {
        showError('loginPassword', 'กรุณากรอกรหัสผ่าน');
        valid = false;
      } else if (password.length < 6) {
        showError('loginPassword', 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัว');
        valid = false;
      }

      if (!valid) return;

      try {
        showLoading('กำลังเข้าสู่ระบบ...');

        // API call สำหรับล็อกอิน (key ต้องเป็น login)
        const res = await fetch(`${API_BASE_URL}/api/user-login/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            login: username,
            password: password
          })
        });

        const data = await res.json();

        if (res.ok && data.user_email) {
          showNotification('เข้าสู่ระบบสำเร็จ! จะนำคุณไปยังหน้าหลัก', 'success');

          // Save user data
          localStorage.setItem('buyer_email', data.user_email || username);
          // Redirect to dashboard
          setTimeout(() => {
            window.location.href = 'buyer-dashboard.html';
          }, 1500);
        } else {
          showNotification(data.error || 'เข้าสู่ระบบไม่สำเร็จ: อีเมล/รหัสผ่านไม่ถูกต้อง', 'error');
        }
      } catch (e) {
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        console.error('[ERROR] login', e);
      } finally {
        hideLoading();
      }
    }
    
    // ==================== Registration Functionality ====================
    let isRegistering = false;
    async function register() {
      if (verificationModal.classList.contains('show') || isRegistering) return;
      isRegistering = true;
      showLoading('กำลังสมัครสมาชิก...');
      
      const fullName = document.getElementById('fullName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Clear errors
      hideError('fullName');
      hideError('phone');
  hideError('email');
      hideError('password');
      hideError('confirmPassword');

      let valid = true;

      // Validation
  if (!fullName) {
        showError('fullName', 'กรุณากรอกชื่อ-นามสกุล');
        valid = false;
      }
      if (!phone) {
        showError('phone', 'กรุณากรอกเบอร์โทรศัพท์');
        valid = false;
      } else if (!/^[0-9]{10}$/.test(phone)) {
        showError('phone', 'เบอร์โทรศัพท์ต้องเป็นตัวเลข 10 หลัก');
        valid = false;
      }
      if (!email) {
        showError('email', 'กรุณากรอกอีเมล');
        valid = false;
      } else if (!/^\S+@\S+\.\S+$/.test(email)) {
        showError('email', 'รูปแบบอีเมลไม่ถูกต้อง');
        valid = false;
      }
      if (!password) {
        showError('password', 'กรุณากรอกรหัสผ่าน');
        valid = false;
      } else if (password.length < 6) {
        showError('password', 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัว');
        valid = false;
      } else if (!/\d/.test(password)) {
        showError('password', 'รหัสผ่านต้องมีตัวเลขอย่างน้อย 1 ตัว');
        valid = false;
      }
      if (!confirmPassword) {
        showError('confirmPassword', 'กรุณายืนยันรหัสผ่าน');
        valid = false;
      } else if (password !== confirmPassword) {
        showError('confirmPassword', 'รหัสผ่านไม่ตรงกัน');
        valid = false;
      }
      
      if (!valid) {
        isRegistering = false;
        hideLoading();
        return;
      }
      
      try {
        // ส่งข้อมูลไปยัง API สำหรับสมัครสมาชิก
        const res = await fetch(`${API_BASE_URL}/api/user-login/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_name: fullName,
            phone: phone,
            email: email,
            password: password
          })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          // แสดงโมดัลยืนยันอีเมล
          showVerificationModal(email);
          // ไม่ต้องสลับแท็บไปที่ล็อกอิน
          showNotification('ส่งรหัสยืนยันไปยังอีเมลของคุณแล้ว', 'success');
        } else {
          showNotification(data.error || 'เกิดข้อผิดพลาดในการสมัครสมาชิก', 'error');
        }
      } catch (e) {
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        console.error('[ERROR] register', e);
      } finally {
        isRegistering = false;
        hideLoading();
      }
    }
    
    // ==================== Reset Password ====================
    function openResetPasswordModal() {
      resetPasswordModal.classList.add('show');
    }
    
    function closeResetPassword() {
      resetPasswordModal.classList.remove('show');
    }
    
    async function resetPassword() {
      const email = document.getElementById('resetEmail').value.trim();
      const newPassword = document.getElementById('resetNewPassword').value;
      const confirmPassword = document.getElementById('resetConfirmPassword').value;
      
      if (!email || !newPassword || !confirmPassword) {
        showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showNotification('รหัสผ่านใหม่ไม่ตรงกัน', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        showNotification('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร', 'error');
        return;
      }
      
      try {
        showLoading('กำลังรีเซ็ตรหัสผ่าน...');
        
        // API call สำหรับรีเซ็ตรหัสผ่าน
        const res = await fetch(`${API_BASE_URL}/api/user-login/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            new_password: newPassword
          })
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
          showNotification('รีเซ็ตรหัสผ่านสำเร็จ! คุณสามารถเข้าสู่ระบบด้วยรหัสผ่านใหม่', 'success');
          closeResetPassword();
        } else {
          showNotification(data.error || 'เกิดข้อผิดพลาดในการรีเซ็ตรหัสผ่าน', 'error');
        }
      } catch (e) {
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        console.error('[ERROR] resetPassword', e);
      } finally {
        hideLoading();
      }
    }
    
    // ==================== Event Listeners ====================
    document.addEventListener('DOMContentLoaded', () => {
      setupPasswordToggles();

      // Button event listeners
      loginBtn.addEventListener('click', login);
      registerBtn.addEventListener('click', register);
      verifyBtn.addEventListener('click', verifyEmail);

      forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        openResetPasswordModal();
      });

      resetPasswordBtn.addEventListener('click', resetPassword);

      resendLink.addEventListener('click', async () => {
        try {
          showLoading('กำลังส่งรหัสยืนยันใหม่...');
          const email = userEmailSpan.textContent;
          // API call สำหรับส่งรหัสยืนยันอีกครั้ง
          const res = await fetch(`${API_BASE_URL}/api/user-login/resend-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showNotification('ส่งรหัสยืนยันใหม่ไปยังอีเมลของคุณแล้ว', 'success');
          } else {
            showNotification(data.error || 'เกิดข้อผิดพลาดในการส่งรหัสยืนยัน', 'error');
          }
        } catch (e) {
          showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
          console.error('[ERROR] resend verification', e);
        } finally {
          hideLoading();
        }
      });

      // เปลี่ยนอีเมล
      document.getElementById('changeEmailBtn').addEventListener('click', function() {
        document.getElementById('changeEmailForm').style.display = 'block';
      });
      document.getElementById('submitChangeEmailBtn').addEventListener('click', async function() {
        const newEmail = document.getElementById('newEmailInput').value.trim();
        if (!/^\S+@\S+\.\S+$/.test(newEmail)) {
          showNotification('กรุณากรอกอีเมลใหม่ให้ถูกต้อง', 'error');
          return;
        }
        showLoading('กำลังเปลี่ยนอีเมล...');
        try {
          // เรียก API เปลี่ยนอีเมล (ใช้ resend-verification แต่เปลี่ยนอีเมล)
          const res = await fetch(`${API_BASE_URL}/api/user-login/resend-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: newEmail })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            userEmailSpan.textContent = newEmail;
            showNotification('เปลี่ยนอีเมลสำเร็จและส่งรหัสยืนยันใหม่แล้ว', 'success');
            document.getElementById('changeEmailForm').style.display = 'none';
          } else {
            showNotification(data.error || 'เกิดข้อผิดพลาดในการเปลี่ยนอีเมล', 'error');
          }
        } catch (e) {
          showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        } finally {
          hideLoading();
        }
      });

      // กลับไปหน้าเข้าสู่ระบบ
      document.getElementById('backToLoginBtn').addEventListener('click', function() {
        verificationModal.classList.remove('show');
        switchToLogin();
      });

      closeResetPasswordModal.addEventListener('click', (e) => {
        e.preventDefault();
        closeResetPassword();
      });

      closeVerificationModal.addEventListener('click', () => {
        verificationModal.classList.remove('show');
      });

      // Enter key submits forms
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          if (verificationModal.classList.contains('show')) {
            verifyEmail();
          } else if (resetPasswordModal.classList.contains('show')) {
            resetPassword();
          } else if (loginForm.classList.contains('active')) {
            login();
          } else if (registerForm.classList.contains('active')) {
            register();
          }
        }
      });
    });
  </script>
</body>
</html>