<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alice Moist Daily - สมัครสมาชิก/ล็อกอิน</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/navbar-footer-style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Kanit', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f0f8ff, #e6f7ff);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      display: flex;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
      /* แก้ไข bug: ไม่ควรมี top/transform/margin: auto ที่ทำให้ container ลอยผิดตำแหน่ง */
      position: static;
      top: unset;
      transform: unset;
      margin: 0 auto;
    }
    
    .illustration {
      flex: 1;
      background: linear-gradient(135deg, #3498db, #2980b9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .illustration::before {
      content: "";
      position: absolute;
      top: -50px;
      left: -50px;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .illustration::after {
      content: "";
      position: absolute;
      bottom: -80px;
      right: -80px;
      width: 250px;
      height: 250px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .illustration img {
      max-width: 300px;
      margin-bottom: 30px;
      z-index: 1;
    }
    
    .illustration h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      z-index: 1;
    }
    
    .illustration p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 500px;
      line-height: 1.6;
      z-index: 1;
    }
    
    .form-container {
      flex: 1;
      padding: 50px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .tab {
      padding: 15px 30px;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: 500;
      color: #888;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .tab.active {
      color: #3498db;
    }
    
    .tab.active::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 3px;
      background: #3498db;
      border-radius: 3px;
    }
    
    .form-section {
      display: none;
    }
    
    .form-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-title {
      font-size: 1.8rem;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .form-subtitle {
      color: #7f8c8d;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }
    
    .input-icon {
      position: relative;
    }
    
    .input-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
    }
    
    .form-control {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #95a5a6;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(19, 20, 21, 0.3);
      filter: none !important;
      opacity: 1 !important;
    }
    
    .form-footer {
      text-align: center;
      margin-top: 25px;
      color: #7f8c8d;
    }
    
    .form-footer a {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }
    
    .form-footer a:hover {
      text-decoration: underline;
    }
    
    .progress-bar {
      height: 5px;
      background: #ecf0f1;
      border-radius: 5px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      width: 33.33%;
      background: #3498db;
      transition: width 0.5s ease;
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .step {
      text-align: center;
      flex: 1;
      position: relative;
    }
    
    .step-number {
      width: 30px;
      height: 30px;
      background: #ecf0f1;
      color: #7f8c8d;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 10px;
      font-weight: 500;
      z-index: 2;
      position: relative;
    }
    
    .step.active .step-number {
      background: #3498db;
      color: white;
    }
    
    .step-title {
      font-size: 0.9rem;
      color: #7f8c8d;
    }
    
    .step.active .step-title {
      color: #3498db;
      font-weight: 500;
    }
    
    .step:not(:last-child)::after {
      content: "";
      position: absolute;
      top: 15px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #ecf0f1;
      z-index: 1;
    }
    
    .step.active:not(:last-child)::after {
      background: #3498db;
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
      .container {
        flex-direction: column;
        /* สำหรับจอเล็ก ให้ margin ปกติ */
        margin: 30px auto;
      }
      
      .illustration {
        padding: 30px;
      }
      
      .illustration img {
        max-width: 200px;
      }
      
      .form-container {
        padding: 30px;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        margin: 10px auto;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .tab {
        padding: 12px 20px;
        font-size: 1rem;
      }
      
      .form-title {
        font-size: 1.5rem;
      }
    }
    
    /* Email Verification Modal */
    .verification-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .verification-modal.show {
      display: flex;
    }
    
    .verification-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: modalFadeIn 0.5s ease;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .verification-icon {
      font-size: 4rem;
      color: #3498db;
      margin-bottom: 20px;
    }
    
    .verification-title {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #2c3e50;
    }
    
    .verification-text {
      color: #7f8c8d;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .verification-code {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .code-input {
      width: 50px;
      height: 60px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .code-input:focus {
      border-color: #3498db;
      outline: none;
    }
    
    .resend-link {
      color: #3498db;
      cursor: pointer;
      margin-top: 20px;
      display: inline-block;
    }
    
    /* Error Message */
    .error-message {
      color: #e74c3c;
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
    }
    
    .input-error .form-control {
      border-color: #e74c3c;
    }
    
    .input-error .error-message {
      display: block;
    }
    /* Password toggle right align for all password fields */
    .input-icon .password-toggle {
      right: 15px;
      left: auto;
      top: 50%;
      transform: translateY(-50%);
      position: absolute;
      z-index: 2;
    }
    /* Add border and shadow to registration form */
    #registerForm {
      border: 1.5px solid #e0e0e0;
      border-radius: 18px;
      box-shadow: 0 4px 18px rgba(52,152,219,0.08), 0 1.5px 6px rgba(44,62,80,0.04);
      background: #fff;
      padding: 35px 30px 30px 30px;
      margin-top: 10px;
    }
    @media (max-width: 576px) {
      #registerForm {
        padding: 18px 5px 18px 5px;
      }
    }
    /* ปุ่มกลับหน้าหลักและแดชบอร์ด */
    .quick-nav-btn {
      background: linear-gradient(135deg, #f0f8ff 60%, #e6f7ff 100%);
      border: 2px solid #3498db;
      color: #3498db;
      font-size: 1.08rem;
      font-weight: 500;
      border-radius: 8px;
      padding: 8px 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(52,152,219,0.08);
      transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s, transform 0.2s;
      outline: none;
    }
    .quick-nav-btn:hover, .quick-nav-btn:focus {
      background: linear-gradient(135deg, #3498db 60%, #2980b9 100%);
      color: #fff;
      border-color: #2980b9;
      box-shadow: 0 4px 16px rgba(52,152,219,0.18);
      transform: translateY(-2px) scale(1.04);
    }
    .quick-nav-btn i {
      font-size: 1.1em;
      margin-right: 2px;
    }
    .nav-quick-btns {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 30px;
      gap: 0;
    }
    .nav-quick-btns .quick-nav-btn {
      min-width: 120px;
      justify-content: center;
    }
    @media (max-width: 576px) {
      .nav-quick-btns {
        flex-direction: column;
        gap: 10px;
        margin-bottom: 18px;
      }
      .nav-quick-btns .quick-nav-btn {
        width: 100%;
        min-width: unset;
      }
    }
    /* ปุ่ม Home และ ไปช้อปปิ้ง */
    .nav-quick-btns {
      position: absolute;
      top: 30px;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 40px;
    }
    /* ===== Notification CSS (copied from dashboard) ===== */
    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 9999;
      background: #fff;
      color: #333;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      padding: 18px 28px;
      min-width: 220px;
      font-size: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(-20px);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .notification.success {
      border-left: 6px solid #2ecc71;
    }
    .notification.error {
      border-left: 6px solid #e74c3c;
    }
    .notification.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .notification.hide {
      opacity: 0;
      pointer-events: none;
      transform: translateY(-20px);
    }
    .notification-content i {
      font-size: 1.3em;
      margin-right: 8px;
    }
  </style>
</head>
<body>
    <div class="container">
      <div class="illustration" style="position:relative;">
        <!-- ===== ปุ่ม Home และ ไปช้อปปิ้ง ไว้บนสุดใน .illustration ===== -->
        <div class="nav-quick-btns" style="position:relative; justify-content:center; gap:10px; margin-bottom:0;">
          <button id="backToHomeBtn" class="quick-nav-btn"><i class="fas fa-home"></i> Home</button>
          <button id="goDashboardBtn" class="quick-nav-btn" style="border-color: #2ecc71; color: #2ecc71;"><i class="fas fa-shopping-bag"></i> ไปช้อปปิ้ง</button>
        </div>
        <span>
          <img src="/images/logo.png" style="background-color: #ffffff;height: 100px; width: auto;border-radius: 35px;box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">
        </span>
        <h1>Alice Moist Daily</h1>
        <p>พบกับประสบการณ์การมองเห็นที่สมบูรณ์แบบด้วยเลนส์สัมผัสรายวันคุณภาพสูงจาก Alice Moist</p>
      </div>
      
      <div class="form-container">
        <div class="tabs">
          <div class="tab active" data-tab="login">เข้าสู่ระบบ</div>
          <div class="tab" data-tab="register">สมัครสมาชิก</div>
        </div>
        
        <!-- Login Form -->
        <div class="form-section active" id="loginForm">
          <h2 class="form-title">ยินดีต้อนรับกลับ</h2>
          <p class="form-subtitle">กรุณากรอกข้อมูลเพื่อเข้าสู่ระบบ</p>
          
          <div class="form-group">
            <label for="loginUsername">อีเมลหรือเบอร์โทรศัพท์</label>
            <div class="input-icon">
              <i class="fas fa-user"></i>
              <input type="text" id="loginUsername" class="form-control" placeholder="อีเมลหรือเบอร์โทรศัพท์">
            </div>
            <div class="error-message" id="loginUsernameError"></div>
          </div>
          
          <div class="form-group">
            <label for="loginPassword">รหัสผ่าน</label>
            <div class="input-icon" style="position: relative;">
              <i class="fas fa-lock"></i>
              <input type="password" id="loginPassword" class="form-control" placeholder="รหัสผ่าน">
              <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">
                <i class="fas fa-eye password-toggle" id="loginPasswordToggle"></i>
              </span>
            </div>
            <div class="error-message" id="loginPasswordError"></div>
          </div>
          
          <button class="btn" id="loginBtn">เข้าสู่ระบบ</button>
          
          <div class="form-footer">
            ลืมรหัสผ่าน? <a href="#" id="forgotPassword">รีเซ็ตรหัสผ่าน</a>
          </div>
        </div>
        
        <!-- Registration Form -->
        <div class="form-section" id="registerForm">
          <div class="progress-bar">
            <div class="progress" id="registrationProgress"></div>
          </div>
          <div class="step-indicator">
            <div class="step active" data-step="1">
              <div class="step-number">1</div>
              <div class="step-title">ข้อมูลส่วนตัว</div>
            </div>
            <div class="step" data-step="2">
              <div class="step-number">2</div>
              <div class="step-title">ข้อมูลล็อกอิน</div>
            </div>
          </div>
          
          <!-- Step 1: Personal Information -->
          <div class="form-step active" id="step1" style="display: block;">
            <h2 class="form-title">ข้อมูลส่วนตัว</h2>
            <p class="form-subtitle">กรุณากรอกข้อมูลส่วนตัวของคุณ</p>
            <div class="form-group">
              <label for="fullName">ชื่อ-นามสกุล</label>
              <div class="input-icon">
                <i class="fas fa-user"></i>
                <input type="text" id="fullName" class="form-control" placeholder="ชื่อ-นามสกุล">
              </div>
              <div class="error-message" id="fullNameError"></div>
            </div>
            <div class="form-group">
              <label for="phone">เบอร์โทรศัพท์</label>
              <div class="input-icon">
                <i class="fas fa-phone"></i>
                <input type="tel" id="phone" class="form-control" placeholder="เบอร์โทรศัพท์">
              </div>
              <div class="error-message" id="phoneError"></div>
            </div>
            <button class="btn next-step" data-next="2">ต่อไป</button>
          </div>
          <!-- Step 2: Login Information -->
          <div class="form-step" id="step2" style="display: none;">
            <h2 class="form-title">ข้อมูลล็อกอิน</h2>
            <p class="form-subtitle">กรุณากรอกข้อมูลสำหรับเข้าสู่ระบบ</p>
            <div class="form-group">
              <label for="email">อีเมล</label>
              <div class="input-icon">
                <i class="fas fa-envelope"></i>
                <input type="email" id="email" class="form-control" placeholder="อีเมล">
              </div>
              <div class="error-message" id="emailError"></div>
            </div>
            <div class="form-group">
              <label for="password">รหัสผ่าน</label>
              <div class="input-icon" style="position: relative;">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" class="form-control" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)">
                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">
                  <i class="fas fa-eye password-toggle"></i>
                </span>
              </div>
              <div class="error-message" id="passwordError"></div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">ยืนยันรหัสผ่าน</label>
              <div class="input-icon" style="position: relative;">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirmPassword" class="form-control" placeholder="ยืนยันรหัสผ่าน">
                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">
                  <i class="fas fa-eye password-toggle"></i>
                </span>
              </div>
              <div class="error-message" id="confirmPasswordError"></div>
            </div>
            <div class="form-row">
              <button class="btn prev-step" data-prev="1">ย้อนกลับ</button>
              <button class="btn next-step" data-next="3">สมัครสมาชิก</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Email Verification Modal -->
    <div class="verification-modal" id="verificationModal">
      <div class="verification-container" style="position:relative;">
        <!-- ปุ่มปิดโมดอล -->
        <button id="closeVerificationModal" style="position:absolute;top:18px;right:18px;background:transparent;border:none;font-size:1.6rem;color:#3498db;cursor:pointer;z-index:10;" aria-label="ปิด">&times;</button>
        <div class="verification-icon">
          <i class="fas fa-envelope-open-text"></i>
        </div>
        <h2 class="verification-title">ยืนยันอีเมลของคุณ</h2>
        <p class="verification-text">เราได้ส่งรหัสยืนยันไปยังอีเมล <span id="userEmail">user@example.com</span> กรุณากรอกรหัสยืนยัน 6 หลักที่ได้รับในอีเมลของคุณ</p>
        <div class="verification-code">
          <input type="text" class="code-input" maxlength="1">
          <input type="text" class="code-input" maxlength="1">
          <input type="text" class="code-input" maxlength="1">
          <input type="text" class="code-input" maxlength="1">
          <input type="text" class="code-input" maxlength="1">
          <input type="text" class="code-input" maxlength="1">
        </div>
        <button class="btn" id="verifyBtn">ยืนยัน</button>
        <div class="form-footer">
          ไม่ได้รับอีเมล? <span class="resend-link" id="resendLink">ส่งอีกครั้ง</span>
        </div>
      </div>
    </div>
    
    <!-- Reset Password Modal -->
    <div class="verification-modal" id="resetPasswordModal">
      <div class="verification-container">
        <div class="verification-icon">
          <i class="fas fa-key"></i>
        </div>
        <h2 class="verification-title">รีเซ็ตรหัสผ่าน</h2>
        <p class="verification-text">กรอกอีเมล รหัสผ่านใหม่ และยืนยันรหัสผ่าน</p>
        <div class="form-group">
          <input type="email" id="resetEmail" class="form-control" placeholder="อีเมล" required>
        </div>
        <div class="form-group">
          <input type="password" id="resetNewPassword" class="form-control" placeholder="รหัสผ่านใหม่ (6 ตัวขึ้นไป)" required>
        </div>
        <div class="form-group">
          <input type="password" id="resetConfirmPassword" class="form-control" placeholder="ยืนยันรหัสผ่านใหม่" required>
        </div>
        <button class="btn" id="resetPasswordBtn">รีเซ็ตรหัสผ่าน</button>
        <div class="form-footer">
          <a href="#" id="closeResetPasswordModal">ยกเลิก</a>
        </div>
      </div>
    </div>
    
    <script>
      // Database simulation using localStorage
      if (!localStorage.getItem('users')) {
        localStorage.setItem('users', JSON.stringify([]));
      }
      
      // ====== ตั้งค่า BASE API URL ให้แก้ไขตรงนี้ ======
      const API_BASE_URL = 'http://localhost:5500'; // เปลี่ยนเป็น IP ของเครื่องที่รัน Node.js
  
      // DOM Elements
      const tabs = document.querySelectorAll('.tab');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const steps = document.querySelectorAll('.step');
      const formSteps = document.querySelectorAll('.form-step');
      const progressBar = document.getElementById('registrationProgress');
      const verificationModal = document.getElementById('verificationModal');
      const userEmailSpan = document.getElementById('userEmail');
      const resendLink = document.getElementById('resendLink');
      const verifyBtn = document.getElementById('verifyBtn');
      const codeInputs = document.querySelectorAll('.code-input');
      
      // Toggle between login and register
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Update tabs
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update forms
          if (tab.dataset.tab === 'login') {
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
            resetRegistration();
          } else {
            loginForm.classList.remove('active');
            registerForm.classList.add('active');
          }
        });
      });
      
      // ===== Notification function (copied from dashboard) =====
      function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type || 'success'}`;
        notification.innerHTML = `
          <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
          </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        setTimeout(() => {
          notification.classList.remove('show');
          notification.classList.add('hide');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 1500);
      }
      
      // Registration Form Navigation
      function goToStep(stepNumber) {
        // Update steps
        steps.forEach(step => {
          if (parseInt(step.dataset.step) <= stepNumber && parseInt(step.dataset.step) <= 2) {
            step.classList.add('active');
          } else {
            step.classList.remove('active');
          }
        });
        // Update form steps
        formSteps.forEach(step => {
          if (step.id === `step${stepNumber}`) {
            step.classList.add('active');
            step.style.display = 'block';
          } else {
            step.classList.remove('active');
            step.style.display = 'none';
          }
        });
        // Update progress bar (2 steps)
        progressBar.style.width = `${((stepNumber - 1) / 1) * 100}%`;
      }
      
      // Next Step Button
      document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', async () => {
          const nextStep = parseInt(button.dataset.next);
          // ถ้าเป็น step 1 (ข้อมูลส่วนตัว) ให้เช็คเบอร์โทรซ้ำก่อน
          if (nextStep === 2) {
            const phone = document.getElementById('phone').value.trim();
            if (phone && /^[0-9]{10}$/.test(phone)) {
              try {
                const dupRes = await fetch(`${API_BASE_URL}/api/check-duplicate`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ phone })
                });
                const dupData = await dupRes.json();
                if (dupData.duplicate) {
                  showNotification(dupData.message || 'เบอร์โทรศัพท์นี้ถูกใช้ไปแล้ว', 'error');
                  showError('phone', dupData.message || 'เบอร์โทรศัพท์นี้ถูกใช้ไปแล้ว');
                  return;
                }
              } catch (e) {
                showNotification('เกิดข้อผิดพลาดในการเช็คเบอร์โทรซ้ำ', 'error');
                return;
              }
            }
          }
          // ถ้าเป็น step 2 (ข้อมูลล็อกอิน) ให้เช็คอีเมลซ้ำก่อน
          if (nextStep === 3) {
            const email = document.getElementById('email').value.trim();
            if (email && /^\S+@\S+\.\S+$/.test(email)) {
              try {
                const dupRes = await fetch(`${API_BASE_URL}/api/check-duplicate`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email })
                });
                const dupData = await dupRes.json();
                if (dupData.duplicate) {
                  showNotification(dupData.message || 'อีเมลนี้ถูกใช้ไปแล้ว', 'error');
                  showError('email', dupData.message || 'อีเมลนี้ถูกใช้ไปแล้ว');
                  return;
                }
              } catch (e) {
                showNotification('เกิดข้อผิดพลาดในการเช็คอีเมลซ้ำ', 'error');
                return;
              }
            }
          }
          // Validate current step before proceeding
          if (validateStep(nextStep - 1)) {
            if (nextStep === 3) {
              // Show modal only, do not go to step 3
              submitRegistration();
            } else {
              goToStep(nextStep);
            }
          }
        });
      });
      
      // Previous Step Button
      document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', () => {
          const prevStep = parseInt(button.dataset.prev);
          goToStep(prevStep);
        });
      });
      
      // Reset registration form
      function resetRegistration() {
        goToStep(1);
        // Clear form fields
        document.getElementById('fullName').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        // Clear errors
        document.querySelectorAll('.error-message').forEach(el => {
          el.style.display = 'none';
        });
        document.querySelectorAll('.form-control').forEach(input => {
          input.classList.remove('input-error');
        });
      }
      
      // Form Validation
      function validateStep(step) {
        let isValid = true;
        if (step === 1) {
          // Validate personal info
          if (!document.getElementById('fullName').value.trim()) {
            showError('fullName', 'กรุณากรอกชื่อ-นามสกุล');
            isValid = false;
          }
          const phone = document.getElementById('phone').value.trim();
          if (!phone) {
            showError('phone', 'กรุณากรอกเบอร์โทรศัพท์');
            isValid = false;
          } else if (!/^[0-9]{10}$/.test(phone)) {
            showError('phone', 'เบอร์โทรศัพท์ต้องเป็นตัวเลข 10 หลัก');
            isValid = false;
          }
        } else if (step === 2) {
          // Validate login info
          const email = document.getElementById('email').value.trim();
          if (!email) {
            showError('email', 'กรุณากรอกอีเมล');
            isValid = false;
          } else if (!/^\S+@\S+\.\S+$/.test(email)) {
            showError('email', 'รูปแบบอีเมลไม่ถูกต้อง');
            isValid = false;
          }
          const password = document.getElementById('password').value;
          if (!password) {
            showError('password', 'กรุณากรอกรหัสผ่าน');
            isValid = false;
          } else if (password.length < 6) {
            showError('password', 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัว');
            isValid = false;
          } else if (!/\d/.test(password)) {
            showError('password', 'รหัสผ่านต้องมีตัวเลขอย่างน้อย 1 ตัว');
            isValid = false;
          }
          const confirmPassword = document.getElementById('confirmPassword').value;
          if (!confirmPassword) {
            showError('confirmPassword', 'กรุณายืนยันรหัสผ่าน');
            isValid = false;
          } else if (password !== confirmPassword) {
            showError('confirmPassword', 'รหัสผ่านไม่ตรงกัน');
            isValid = false;
          }
        }
        return isValid;
      }
      
      // Show error message
      function showError(fieldId, message) {
        const errorElement = document.getElementById(`${fieldId}Error`);
        const inputElement = document.getElementById(fieldId);
        
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        inputElement.classList.add('input-error');
      }
      
      // Submit registration
      async function submitRegistration() {
        if (validateStep(2)) {
          const user = {
            user_name: document.getElementById('fullName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
            user_role: 'buyer',
            user_profile_img: ''
          };
          // เช็คซ้ำฝั่ง client ก่อน
          try {
            const dupRes = await fetch(`${API_BASE_URL}/api/check-duplicate`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: user.email, phone: user.phone })
            });
            const dupData = await dupRes.json();
            if (dupData.duplicate) {
              showNotification(dupData.message || 'อีเมลหรือเบอร์โทรศัพท์นี้ถูกใช้ไปแล้ว', 'error');
              if (dupData.message && dupData.message.includes('อีเมล')) {
                showError('email', dupData.message);
              } else if (dupData.message && dupData.message.includes('เบอร์')) {
                showError('phone', dupData.message);
              }
              return;
            }
          } catch (e) {
            showNotification('เกิดข้อผิดพลาดในการเช็คข้อมูลซ้ำ', 'error');
            return;
          }
          // Show modal immediately
          showVerificationModal(user.email);
          // Show loading message
          const loadingMsg = document.createElement('div');
          loadingMsg.id = 'verificationLoadingMsg';
          loadingMsg.style.color = '#3498db';
          loadingMsg.style.marginBottom = '10px';
          loadingMsg.textContent = 'กำลังส่งรหัสยืนยันไปยังอีเมล กรุณารอสักครู่...';
          verificationModal.querySelector('.verification-container').insertBefore(loadingMsg, verificationModal.querySelector('.verification-code'));
          try {
            const res = await fetch(`${API_BASE_URL}/api/register`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(user)
            });
            const data = await res.json();
            // Remove loading message
            if (document.getElementById('verificationLoadingMsg')) {
              document.getElementById('verificationLoadingMsg').remove();
            }
            if (data.success && data.user_id && user.email) {
              localStorage.setItem('buyer_user_id', data.user_id);
              localStorage.setItem('buyer_email', user.email);
            }
            if (!data.success) {
              verificationModal.classList.remove('show');
              showNotification(data.error || 'เกิดข้อผิดพลาด', 'error');
            }
          } catch (e) {
            if (document.getElementById('verificationLoadingMsg')) {
              document.getElementById('verificationLoadingMsg').remove();
            }
            verificationModal.classList.remove('show');
            showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
          }
        }
      }
      
      // Show verification modal
      function showVerificationModal(email) {
        userEmailSpan.textContent = email;
        verificationModal.classList.add('show');
        
        // Clear code inputs
        codeInputs.forEach(input => input.value = '');
        
        // Focus first input
        codeInputs[0].focus();
      }
      
      // Verify email
      verifyBtn.addEventListener('click', async () => {
        let code = '';
        codeInputs.forEach(input => { code += input.value; });
        if (code.length === 6 && /^\d{6}$/.test(code)) {
          const email = userEmailSpan.textContent;
          try {
            const res = await fetch(`${API_BASE_URL}/api/verify-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, code })
            });
            const data = await res.json();
            if (data.success) {
              verificationModal.classList.remove('show');
              showNotification('ยืนยันอีเมลสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว', 'success');
              // Save user_id and email to localStorage (for buyer) after register & verify
              if (data.user_id && email) {
                localStorage.setItem('buyer_user_id', data.user_id);
                localStorage.setItem('buyer_email', email);
              }
              tabs[0].click();
            } else {
              showNotification(data.error || 'รหัสยืนยันไม่ถูกต้อง', 'error');
            }
          } catch (e) {
            showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
          }
        } else {
          showNotification('กรุณากรอกรหัสยืนยัน 6 หลัก', 'error');
        }
      });
      
      // Resend verification code
      resendLink.addEventListener('click', () => {
        showNotification('ส่งรหัสยืนยันใหม่ไปยังอีเมลของคุณแล้ว', 'success');
      });
      
      // Auto-tab between code inputs
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
          if (input.value.length === 1 && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && input.value === '' && index > 0) {
            codeInputs[index - 1].focus();
          }
        });
      });
      
      // Password toggle visibility
      document.querySelectorAll('.password-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          const input = this.closest('.input-icon').querySelector('input');
          const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
          input.setAttribute('type', type);
          this.classList.toggle('fa-eye');
          this.classList.toggle('fa-eye-slash');
        });
      });
      
      // Login functionality
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        // Clear errors
        document.querySelectorAll('#loginForm .error-message').forEach(el => {
          el.style.display = 'none';
        });
        document.querySelectorAll('#loginForm .form-control').forEach(input => {
          input.classList.remove('input-error');
        });
        if (!username) {
          showError('loginUsername', 'กรุณากรอกอีเมลหรือเบอร์โทรศัพท์');
          return;
        }
        if (!password) {
          showError('loginPassword', 'กรุณากรอกรหัสผ่าน');
          return;
        }
        try {
          const res = await fetch(`${API_BASE_URL}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (res.ok) {
            // Save user info to sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(data));
            // Save user_id and email to localStorage (for buyer)
            if (data && data.user_id && data.email) {
              localStorage.setItem('buyer_user_id', data.user_id);
              localStorage.setItem('buyer_email', data.email);
            }
            showNotification('เข้าสู่ระบบสำเร็จ! จะนำคุณไปยังหน้าหลัก', 'success');
            setTimeout(() => {
              // ดึงข้อมูล user จาก sessionStorage ไปใส่ใน dropdown (ถ้ามี navbar)
              if (window.updateUserUI) window.updateUserUI();
              window.location.href = 'buyer-dashboard.html';
            }, 1200);
          } else {
            showNotification(data.error || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
          }
        } catch (e) {
          showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        }
      });
      
      // Forgot password
      document.getElementById('forgotPassword').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('resetPasswordModal').classList.add('show');
      });
      document.getElementById('closeResetPasswordModal').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('resetPasswordModal').classList.remove('show');
      });
      document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
        const email = document.getElementById('resetEmail').value.trim();
        const newPassword = document.getElementById('resetNewPassword').value;
        const confirmPassword = document.getElementById('resetConfirmPassword').value;
        if (!email || !newPassword || !confirmPassword) {
          showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
          return;
        }
        if (newPassword !== confirmPassword) {
          showNotification('รหัสผ่านใหม่ไม่ตรงกัน', 'error');
          return;
        }
        if (newPassword.length < 6) {
          showNotification('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร', 'error');
          return;
        }
        try {
          const res = await fetch(`${API_BASE_URL}/api/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, newPassword, confirmPassword })
          });
          const data = await res.json();
          if (data.success) {
            showNotification('รีเซ็ตรหัสผ่านสำเร็จ! คุณสามารถเข้าสู่ระบบด้วยรหัสผ่านใหม่', 'success');
            document.getElementById('resetPasswordModal').classList.remove('show');
          } else {
            showNotification(data.error || 'เกิดข้อผิดพลาดในการรีเซ็ตรหัสผ่าน', 'error');
          }
        } catch (e) {
          showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
        }
      });
      
      // ปุ่มย้อนกลับหน้าหลัก
      document.getElementById('backToHomeBtn').onclick = function() {
        window.location.href = '../index.html';
      };
      // ปุ่มไปหน้า Dashboard
      document.getElementById('goDashboardBtn').onclick = function() {
        window.location.href = 'buyer-dashboard.html';
      };
      
      // Enter key triggers button click for login/register/next
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          const activeTab = document.querySelector('.tab.active').dataset.tab;
          if (activeTab === 'login') {
            document.getElementById('loginBtn').click();
          } else if (activeTab === 'register') {
            // หา step ที่ active
            const activeStep = Array.from(document.querySelectorAll('.form-step')).find(step => step.classList.contains('active'));
            if (activeStep) {
              // หา next-step button ใน step ปัจจุบัน
              const nextBtn = activeStep.querySelector('.next-step');
              if (nextBtn) nextBtn.click();
            }
          }
        }
      });
      // เพิ่ม JS สำหรับปุ่มปิดโมดาลอีเมลเวอริไฟ
      document.getElementById('closeVerificationModal').addEventListener('click', function() {
        document.getElementById('verificationModal').classList.remove('show');
      });
    </script>
  </body>
</html>